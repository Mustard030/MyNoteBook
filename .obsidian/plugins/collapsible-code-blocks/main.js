/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var T=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var U=(a,i)=>{for(var e in i)T(a,e,{get:i[e],enumerable:!0})},Y=(a,i,e,o)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of K(i))!G.call(a,t)&&t!==e&&T(a,t,{get:()=>i[t],enumerable:!(o=j(i,t))||o.enumerable});return a};var J=a=>Y(T({},"__esModule",{value:!0}),a);var X={};U(X,{default:()=>I});module.exports=J(X);var f=require("obsidian");var C={defaultCollapsed:!1,collapseIcon:"\u25BC",expandIcon:"\u25B6",enableHorizontalScroll:!0,collapsedLines:0,buttonAlignment:"left",transparentButton:!1};var w=require("@codemirror/view"),H=require("@codemirror/language"),S=require("@codemirror/state"),D=require("obsidian"),k=S.StateEffect.define(),x=class extends w.WidgetType{constructor(e,o,t,n,s){super();this.startPos=e;this.endPos=o;this.settings=t;this.foldField=n;this.app=s}static getFrontmatterCodeBlockState(e){var s;let o=e.workspace.getActiveViewOfType(D.MarkdownView);if(!(o!=null&&o.file))return null;let t=e.metadataCache.getFileCache(o.file);if(!((s=t==null?void 0:t.frontmatter)!=null&&s["code-blocks"]))return null;let n=t.frontmatter["code-blocks"].toLowerCase();return n==="collapsed"?!0:n==="expanded"?!1:null}getBlockId(){var o;let e=(o=this.app.workspace.getActiveViewOfType(D.MarkdownView))==null?void 0:o.file;return`${(e==null?void 0:e.path)||""}-${this.startPos}-${this.endPos}`}initializeCodeBlock(e){let o=this.getBlockId();if(x.initializedBlocks.has(o))return;x.initializedBlocks.add(o);let t=x.getFrontmatterCodeBlockState(this.app);if(t!==null?t:this.settings.defaultCollapsed){let s=!1;e.state.field(this.foldField).between(this.startPos,this.endPos,()=>{s=!0}),s||requestAnimationFrame(()=>{e.dispatch({effects:k.of({from:this.startPos,to:this.endPos,defaultState:!0})})})}}toDOM(e){let o=document.createElement("div");o.className="code-block-toggle";let t=!1;return e.state.field(this.foldField).between(this.startPos,this.endPos,()=>{t=!0}),this.initializeCodeBlock(e),o.innerHTML=t?this.settings.expandIcon:this.settings.collapseIcon,o.setAttribute("aria-label",t?"Expand code block":"Collapse code block"),o.onclick=n=>{n.preventDefault(),n.stopPropagation(),e.dispatch({effects:k.of({from:this.startPos,to:this.endPos,defaultState:!t})})},o}static clearInitializedBlocks(){x.initializedBlocks.clear()}},y=x;y.initializedBlocks=new Set;var Q=a=>S.StateField.define({create(){return w.Decoration.none},update(i,e){i=i.map(e.changes);for(let o of e.effects)if(o.is(k)){let{from:t,to:n,defaultState:s}=o.value,u=!1;if(i.between(t,n,()=>{u=!0}),!(s!==void 0?s:!u))i=i.update({filter:(c,r)=>c!==t||r!==n});else if(!u){let c=t,r=n,d=w.Decoration.replace({block:!0,inclusiveStart:!0,inclusiveEnd:!1,widget:new class extends w.WidgetType{toDOM(p){let g=document.createElement("div");g.className="code-block-folded",g.style.setProperty("--collapsed-lines",a.collapsedLines.toString());let m=document.createElement("div");m.className="folded-content";let h=p.state.doc.sliceString(c,r).split(`
`),E=h[0].match(/^```(\w+)?/),v=E&&E[1]?E[1]:"",b=h.slice(1);b.length>0&&b[b.length-1].trim().startsWith("```")&&(b=b.slice(0,-1));let $=b.slice(0,a.collapsedLines).join(`
`),L=document.createElement("pre"),B=document.createElement("code");v&&(B.className=`language-${v}`,L.className=`language-${v}`),B.textContent=$,L.appendChild(B),m.appendChild(L),requestAnimationFrame(()=>{typeof Prism!="undefined"&&v&&Prism.highlightElement(B)});let P=document.createElement("div");return P.className="code-block-toggle",P.textContent=a.expandIcon,P.onclick=F=>{F.preventDefault(),F.stopPropagation(),p.dispatch({effects:k.of({from:c,to:r,defaultState:!1})})},g.appendChild(P),g.appendChild(m),g}}});i=i.update({add:[d.range(t,n)]})}}return i},provide:i=>w.EditorView.decorations.from(i)}),O=S.StateField.define({create(a){return z(a)},update(a,i){return z(i.state)}});function z(a){let i=[];return(0,H.syntaxTree)(a).iterate({enter:e=>{let o=e.type.name;if(o.includes("HyperMD-codeblock-begin")){let t=document.querySelector(`.${o}`);t&&t.parentElement&&t.parentElement.classList.add("ccb-editor-codeblock");let n=a.doc.lineAt(e.from);if(n.text.trim().startsWith("```")){let s=!1;for(let u=n.number;u<=a.doc.lines;u++){let l=a.doc.line(u);if(u!==n.number&&l.text.trim().startsWith("```")){i.push({startPos:n.from,endPos:l.to}),s=!0;break}}s||i.push({startPos:n.from,endPos:a.doc.line(a.doc.lines).to})}}}}),i}function N(a,i,e,o){let t=[];return a.field(O).forEach(s=>{let u=w.Decoration.widget({widget:new y(s.startPos,s.endPos,i,e,o),side:-1});t.push(u.range(s.startPos))}),w.Decoration.set(t,!0)}function R(a,i){let e=Q(a),o=S.StateField.define({create(n){return N(n,a,e,i)},update(n,s){return N(s.state,a,e,i)},provide(n){return w.EditorView.decorations.from(n)}}),t=S.EditorState.transactionFilter.of(n=>{if(!n.docChanged)return n;let s=n.startState.field(e),u=[];return n.changes.iterChanges((l,c,r,d,p)=>{s.between(0,n.startState.doc.length,(g,m)=>{l<=m&&c>=g&&u.push(k.of({from:g,to:m,defaultState:!1}))})}),u.length>0?[n,{effects:u}]:n});return[O,e,o,t]}var V=require("obsidian");function q(a,i){function e(){var d;let l=a.workspace.getActiveViewOfType(V.MarkdownView);if(!(l!=null&&l.file))return null;let c=a.metadataCache.getFileCache(l.file);if(!((d=c==null?void 0:c.frontmatter)!=null&&d["code-blocks"]))return null;let r=c.frontmatter["code-blocks"].toLowerCase();return r==="collapsed"?!0:r==="expanded"?!1:null}function o(){let l=document.createElement("div");l.className="code-block-toggle",l.textContent=i.collapseIcon,l.setAttribute("role","button"),l.setAttribute("tabindex","0"),l.setAttribute("aria-label","Toggle code block visibility");let c=r=>{r.preventDefault();let d=r.target.closest("pre");if(!d)return;d.classList.toggle("collapsed"),t(d,!0);let p=d.classList.contains("collapsed");l.textContent=p?i.expandIcon:i.collapseIcon,l.setAttribute("aria-expanded",(!p).toString()),a.workspace.requestSaveLayout()};return l.addEventListener("click",c),l.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),c(r))}),l}function t(l,c=!1){var E;let r=l.classList.contains("collapsed"),d=a.workspace.getActiveViewOfType(V.MarkdownView);if(!((E=d==null?void 0:d.previewMode)!=null&&E.containerEl))return;let p=d.previewMode.containerEl,g=l.getBoundingClientRect(),m=p.scrollTop,A=g.top+m,h=l.nextElementSibling;for(;h&&!(h instanceof HTMLPreElement);)h instanceof HTMLElement&&(r?(h.classList.add("element-hidden"),h.classList.remove("element-visible","element-spacing")):(h.classList.remove("element-hidden"),h.classList.add("element-visible"))),h=h.nextElementSibling;l.offsetHeight,(async()=>{window.dispatchEvent(new Event("resize")),await new Promise(b=>requestAnimationFrame(b));let v=p.scrollTop;p.scrollTop=Math.max(0,p.scrollHeight-p.clientHeight),await new Promise(b=>requestAnimationFrame(b)),p.scrollTop=v,window.dispatchEvent(new Event("resize")),await new Promise(b=>setTimeout(b,50)),window.dispatchEvent(new Event("resize"))})()}function n(l){document.documentElement.style.setProperty("--collapsed-lines",i.collapsedLines.toString());let c=o();l.insertBefore(c,l.firstChild);let r=e();(r!==null?r:i.defaultCollapsed)&&(l.classList.add("collapsed"),c.textContent=i.expandIcon,t(l,!0))}function s(l){l.querySelectorAll("pre:not(.has-collapse-button)").forEach(c=>{if(!(c instanceof HTMLElement))return;c.classList.add("has-collapse-button","ccb-code-block");let r=c.querySelector("code");r&&r.classList.add("ccb-hide-vertical-scrollbar"),n(c)})}function u(l){return new MutationObserver(c=>{c.forEach(r=>{r.type==="childList"&&l(r.target)})})}return{processNewCodeBlocks:s,setupContentObserver:u}}var I=class extends f.Plugin{async onload(){await this.loadSettings(),this.updateScrollSetting(),this.updateButtonAlignment(),this.updateButtonTransparency(),document.documentElement.style.setProperty("--collapsed-lines",this.settings.collapsedLines.toString());let e=R(this.settings,this.app);this.registerEditorExtension(e),this.addCommand({id:"toggle-code-block-at-cursor",name:"Toggle code block containing cursor",editorCheckCallback:(o,t,n)=>o?t.cm!=null:(this.toggleCodeBlockAtCursor(t),!0),hotkeys:[{modifiers:["Mod","Shift"],key:"K"}]}),this.registerEvent(this.app.workspace.on("file-open",()=>{y.clearInitializedBlocks()})),this.readViewAPI=q(this.app,this.settings),this.contentObserver=this.readViewAPI.setupContentObserver(this.readViewAPI.processNewCodeBlocks),this.registerMarkdownPostProcessor(o=>{this.readViewAPI.processNewCodeBlocks(o),this.contentObserver.observe(o,{childList:!0,subtree:!0})}),this.addSettingTab(new M(this.app,this))}updateScrollSetting(){document.body.setAttribute("data-ccb-horizontal-scroll",this.settings.enableHorizontalScroll.toString())}updateButtonAlignment(){document.body.setAttribute("data-button-alignment",this.settings.buttonAlignment)}updateButtonTransparency(){document.body.setAttribute("data-transparent-button",this.settings.transparentButton.toString())}toggleCodeBlockAtCursor(e){let o=e.cm;if(!o)return;let t=o.state,n=t.selection.main.head,s=t.doc,u=s.lineAt(n),l=-1,c=-1,r=null,d=null;if(u.text.trim().startsWith("```")){r=u;for(let p=u.number+1;p<=s.lines;p++){let g=s.line(p);if(g.text.trim().startsWith("```")){d=g;break}}d&&(l=r.from,c=d.to)}else for(let p=u.number-1;p>=1;p--){let g=s.line(p);if(g.text.trim().startsWith("```")){r=g;for(let m=p+1;m<=s.lines;m++){let A=s.line(m);if(A.text.trim().startsWith("```")){d=A;break}}if(d&&n>=r.from&&n<=d.to){l=r.from,c=d.to;break}else r=null,d=null}}l!==-1&&c!==-1&&o.dispatch({effects:k.of({from:l,to:c})})}sanitizeIcon(e){let o=e.trim();return o.length<=2||this.app.customIcons&&this.app.customIcons.exists(o)?o:C.collapseIcon}async loadSettings(){var o,t;let e=await this.loadData();this.settings={...C,...e,collapseIcon:this.sanitizeIcon((o=e==null?void 0:e.collapseIcon)!=null?o:C.collapseIcon),expandIcon:this.sanitizeIcon((t=e==null?void 0:e.expandIcon)!=null?t:C.expandIcon)}}async saveSettings(){this.settings.collapseIcon=this.sanitizeIcon(this.settings.collapseIcon),this.settings.expandIcon=this.sanitizeIcon(this.settings.expandIcon),await this.saveData(this.settings)}onunload(){var e;(e=this.contentObserver)==null||e.disconnect(),document.body.removeAttribute("data-ccb-horizontal-scroll"),document.body.removeAttribute("data-button-alignment"),document.body.removeAttribute("data-transparent-button")}},M=class extends f.PluginSettingTab{constructor(e,o){super(e,o);this.app=e,this.plugin=o}display(){let{containerEl:e}=this;e.empty(),new f.Setting(e).setName("Default collapsed state").setDesc("Should code blocks be collapsed by default?").addToggle(t=>t.setValue(this.plugin.settings.defaultCollapsed).onChange(async n=>{this.plugin.settings.defaultCollapsed=n,await this.plugin.saveSettings()})),new f.Setting(e).setName("Collapse icon").setDesc("Icon to show when code block is expanded (single character or emoji only)").addText(t=>t.setValue(this.plugin.settings.collapseIcon).onChange(async n=>{let s=n.trim();s.length<=2&&(this.plugin.settings.collapseIcon=s||C.collapseIcon,await this.plugin.saveSettings())})),new f.Setting(e).setName("Expand icon").setDesc("Icon to show when code block is collapsed (single character or emoji only)").addText(t=>t.setValue(this.plugin.settings.expandIcon).onChange(async n=>{let s=n.trim();s.length<=2&&(this.plugin.settings.expandIcon=s||C.expandIcon,await this.plugin.saveSettings())})),new f.Setting(e).setName("Enable horizontal scrolling").setDesc("Allow code blocks to scroll horizontally instead of wrapping text.").addToggle(t=>t.setValue(this.plugin.settings.enableHorizontalScroll).onChange(async n=>{this.plugin.settings.enableHorizontalScroll=n,await this.plugin.saveSettings(),this.plugin.updateScrollSetting()})),new f.Setting(e).setName("Collapsed lines").setDesc("Number of lines visible when code block is collapsed").addText(t=>{t.setValue(this.plugin.settings.collapsedLines.toString()).onChange(async n=>{let s=parseInt(n,10);this.plugin.settings.collapsedLines=isNaN(s)||s<0?0:s,await this.plugin.saveSettings(),document.documentElement.style.setProperty("--collapsed-lines",this.plugin.settings.collapsedLines.toString())})}),new f.Setting(e).setName("Button alignment").setDesc("Align the collapse/expand button to the left or right side of the code block").addDropdown(t=>t.addOption("left","Left").addOption("right","Right").setValue(this.plugin.settings.buttonAlignment).onChange(async n=>{this.plugin.settings.buttonAlignment=n,await this.plugin.saveSettings(),this.plugin.updateButtonAlignment()})),new f.Setting(e).setName("Transparent button").setDesc("Make the collapse/expand button transparent until hovered over").addToggle(t=>t.setValue(this.plugin.settings.transparentButton).onChange(async n=>{this.plugin.settings.transparentButton=n,await this.plugin.saveSettings(),this.plugin.updateButtonTransparency()})),new f.Setting(e).setName("Keyboard shortcut").setDesc("Toggle the code block containing the cursor. Default: Cmd/Ctrl+Shift+K. You can customize this in Settings \u2192 Hotkeys").addButton(t=>t.setButtonText("Open Hotkey Settings").onClick(()=>{var s,u;this.app.setting.openTabById("hotkeys");let n=(u=(s=this.app.setting.activeTab)==null?void 0:s.searchComponent)==null?void 0:u.inputEl;n&&(n.value="Toggle code block containing cursor",n.dispatchEvent(new Event("input")))}))}};

/* nosourcemap */